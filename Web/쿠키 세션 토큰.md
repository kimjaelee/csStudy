# 쿠키 세션 토큰

💡 **쿠키와 세션의 등장 이유**
HTTP 통신은 요청, 응답이 종료되면 stateless한 특징 때문에 연결을 끊는 처리 방식이다. 로그인과 같이 ‘누가’ 로그인 중인지 상태를 기억하기 위해 쿠키, 세션, 쿠키를 사용한다.

**_Connectionless 프로토콜 (비연결 지향)_**

- 클라이언트가 서버에 요청했을 때, 요청에 맞는 응답을 보낸 후 연결을 끊는 처리방식

**_Stateless 프로토콜 (상태정보 유지 안함)_**

- 클라이언트의 상태 정보를 가지지않는 서버 처리 방식
- 클라이언트와 첫 번째 통신에 데이터를 주고 받아도, 두번째 통신에 이전 데이터를 유지하지 않음

> > 따라서 첫 번째 로그인 후 마이페이지를 요청해도 서버는 사용자가 누구인지 알 수 없음!

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/15fbc157-5cac-43d9-8ee4-dc581d5a1e24/db64f437-3223-4110-af47-6473a818b28f/Untitled.png)

## ⚙ 쿠키

---

- 공개 가능한 정보를 사용자의 **브라우저에 저장**시킨다.
- 서버는 클라이언트의 로그인 요청에 대한 응답을 작성할 때, 클라이언트 측에 저장하고 싶은 정보를 응답 헤더의 `set-cookie`에 담는다.
- 이후 클라이언트가 재요청 할 때마다 저장된 쿠키를 요청 헤더의 `cookie`에 담아 보낸다
- 서버는 쿠키에 담긴 정보를 바탕으로 해당 요청의 클라이언트가 누군지 식별할 수 있다.
- 제 3자가 조회하는 것도 가능하기에 개인 정보, 민감한 정보를 저장하는데 적합하지 않음.

## ⚙ 세션

---

- 사용자의 로그인 상태를 유지하는 기능을 위해 쿠키에 아이디와, 비밀번호 정보를 담아두고 있다면, 개인 소유가 아닌 컴퓨터에서 사용할 경우 사용자의 정보가 유출될 것이고, http로 개인정보를 주고 받다보면 쿠키가 유출, 조작 될 수 있는 보안상의 큰 문제를 야기한다.
- session은 비밀번호와 같은 인증 정보를 쿠키에 저장하지 않고, 사용자의 식별자인 sessoion id를 저장하여 서버에는 인증 정보와 더불어, 이 id에 해당하는 사용자 정보를 저장함.
- 사용자는 서버로부터 받은 세션 아이디를 쿠키로 저장, 다음 요청들에 함께 전달함.
- 세션은 **서버에 저장**하기 때문에 사용자가 수백, 수천, 수만으로 늘어난다면 해당 유저의 정보를 찾고 데이터 매칭에 오랜 시간이 걸려 서버에 부하가 가해짐

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/15fbc157-5cac-43d9-8ee4-dc581d5a1e24/7d0f8421-eb15-4dd6-9c39-063564cfd328/Untitled.png)

## ⚙ 토큰

---

- 토큰은 세션과는 또 다른 로그인 유지 방식이다. 세션의 경우 요청마다 세션 id를 포함하게 되는데, 이 때 사용자 인증 과정에서 메모리를 사용하게 된다.(메모리에 로그인된 사용자의 상태 보관) 서버 동시 접속자가 많다면 메모리 공간이 부족해져 서버에 부하가 걸리고, 화면이 움직이지 않는 등의 문제를 야기할 수 있는 단점이 존재한다.
- 토큰은 위와 같은 세션의 대안책으로 session id 대신 토큰을 발급해주는 것이다. 서버만이 유효한 토큰을 발행할 수 있고 사용자는 해당 토큰을 쿠키로써 저장하고 필요할 때 마다 제시하여 서버가 본인이 발급한 토큰인지를 확인하는 작업을 하게된다.(세션의 단점 극복 → 서버 부하 감소) 헤더, 페이로드, 서명 세파트를 `.` 으로 구분하는 구조이다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/15fbc157-5cac-43d9-8ee4-dc581d5a1e24/12350e04-36c7-4fef-9739-d6dfa7c8d87c/Untitled.png)

### Header

> JWT를 검증하는데 필요한 정보를 가진 JSON 객체는 Base64 URL-Safe 인코딩된 문자열임. 헤더는 jwt를 어떻게 검증(verify)하는가에 대한 내용을 담고 있음. 
> alg는 서명시 사용하는 알고리즘이고, kid는 서명시 사용하는 키(pubilc/private key)를 식별하는 값에 해당함.

### Payload

> JWT의 내용에 해당함. 페이로드에 있는 속성들을 클레임 셋(Claim Set)이라고 부르며, 클레임 셋은 JWT에 대한 내용(토큰 생성자의 정보, 생성일시 등)이나 클라이언트와 서버 간 주고받기로 한 **데이터**들로 구성됨.

### Signature

> 점`.`을 구분자로 헤더와 페이로드를 합진 문자열을 서명한 값. 서명은 헤더의 alg에 정의된 알고리즘과 비밀 키를 이용해 생성함. Base64 URL-Safe로 인코딩됨.

**_장점_**

- header와 payload 를 가지고 signaure를 생성 → 데이터 위변조를 막을 수 있음
- 인증 정보에 대한 별도의 저장소 X
  (서버 부하 ↓)
- JWT는 토큰에 대한 기본 정보와 전달할 정보 및 토큰이 검증 되었다는 서명 등 필요한 모든 정보를 자체적으로 지니고 있음
- 토큰은 한 번 발급되면 유효기간이 만료될 때까지 계속 사용이 가능

**_단점_**

- 쿠키/세션과 다르게 JWT는 토큰의 길이가 길어 인증 요청이 많아질수록 네트워크 부하 증가
- payload 자제는 암호화되지 않기 때문에 유저의 중요한 정보를 담아선 안됨
- 토큰을 탈취 시 대처 어려움
- 특정 사용자 접속을 강제로 만료하기 어려움. (쿠키/세션 기반 인증은 서버 쪽에서 쉽게 세션을 삭제 가능)

- **💌 보안 전략**
  ### 1. 짧은 만료 기한 설정
  토큰의 만료 시간이 짧으면 탈취 되더라도 금방 만료되기 때문에 피해를 최소화 할 수 있음. (=사용자가 자주 로그인 해야 함)
  ### 2. Sliding Session
  로그인하고 글을 작성하는 도중 토큰이 만료 된다면 저장 작업이 정상적으로 작동하지 않고 작성한 글이 날아가는 일이 생기는 등 불편함이 존재함. Sliding Session은 서비스를 지속적으로 이용하는 클라이언트에게 자동으로 토큰 만료 기한을 늘려주는 방법입니다. (1번 단점 보완)
  ### 3. Refresh Token
  클라이언트가 로그인 요청을 보내면 서버는 Access Token과 함께 보다 만료 기간이 긴 Refresh Token을 함께 내려줌. 클라이언트는 Access Token이 만료되었을 때, Refresh Token을 사용하여 Acess Token의 재발급을 요청. 서버는 DB에 저장된 Refresh Token과 비교하여 유효한 경우 새로운 Access Token을 발급하고, 만료된 경우 재로그인.
  검증을 위해서는 서버에 Refresh Token을 별도로 저장 시켜야함.
-

### 세션과 토큰

---

|      | 세션 방식                                            | 토큰 방식                           |
| ---- | ---------------------------------------------------- | ----------------------------------- |
| 장점 | 사용자의 상태를 원하는대로 통제 가능                 | 상태를 따로 기억해 둘 필요가 없음   |
| 단점 | 메모리에 로그인되어 있는 사용자의 상태를 보관해야 함 | 한 번 로그인한 사용자의 상태의 토큰 |

### **REFERENCE**

---

- [https://velog.io/@jung5318/쿠키-세션-토큰의-차이점](https://velog.io/@jung5318/%EC%BF%A0%ED%82%A4-%EC%84%B8%EC%85%98-%ED%86%A0%ED%81%B0%EC%9D%98-%EC%B0%A8%EC%9D%B4%EC%A0%90)
- [https://hongong.hanbit.co.kr/완벽-정리-쿠키-세션-토큰-캐시-그리고-cdn/](https://hongong.hanbit.co.kr/%EC%99%84%EB%B2%BD-%EC%A0%95%EB%A6%AC-%EC%BF%A0%ED%82%A4-%EC%84%B8%EC%85%98-%ED%86%A0%ED%81%B0-%EC%BA%90%EC%8B%9C-%EA%B7%B8%EB%A6%AC%EA%B3%A0-cdn/)
